import { OpenAI } from "openai";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// 简单内存多轮对话缓存（每次服务器重启清空）
const conversationHistory = {};

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    const { userId, message } = req.body;

    if (!userId || !message) {
      return res.status(400).json({ error: "Missing userId or message" });
    }

    // 获取用户历史对话
    if (!conversationHistory[userId]) {
      conversationHistory[userId] = [
        { role: "system", content: "你是一个耐心、幽默、技术能力很强的助手。" }
      ];
    }

    // 加入用户消息
    conversationHistory[userId].push({ role: "user", content: message });

    // 调用 OpenAI ChatCompletion
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: conversationHistory[userId]
    });

    const reply = completion.choices[0].message.content;

    // 保存助手回答
    conversationHistory[userId].push({ role: "assistant", content: reply });

    res.status(200).json({ reply });
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: error.message || "Something went wrong" });
  }
}
